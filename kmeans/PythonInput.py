# coding: utf-8

from os.path import abspath

import pandas as pd
from pyspark.sql import SparkSession
from sklearn.cluster import KMeans

warehouse_location = abspath('hdfs://10.31.1.11:8020/user/hive/warehouse')
spark = SparkSession \
    .builder \
    .appName("pyspark") \
    .config("spark.sql.warehouse.dir", warehouse_location) \
    .enableHiveSupport().getOrCreate()

sql_salary_classification = "select * from  tmp_fk_am.zdy_client_cluster_02_ind_info_v2 limit 100"
# 读取hive的数据
df = spark.sql(sql_salary_classification)
df.describe().transpose()
trainData = df

X_train = trainData[['customer_id',
                     'app_date',
                     'contract_no',
                     'edu1',
                     'edu2',
                     'edu3',
                     'edu4',
                     'edu5',
                     'edu6',
                     'edu7',
                     'edu8',
                     'cus_childrentotal',
                     'cus_age',
                     'marry1',
                     'marry2',
                     'marry3',
                     'marry4',
                     'cus_sex',
                     'email',
                     'is_qq',
                     'native',
                     'work_flow1',
                     'work_flow2',
                     'work_flow3',
                     'work_flow4',
                     'familyadd_same_reg',
                     'nativecity_familycity',
                     'house1',
                     'house2',
                     'house3',
                     'house4',
                     'house5',
                     'house6',
                     'indus_1',
                     'indus_2',
                     'indus_3',
                     'indus_4',
                     'indus_5',
                     'indus_6',
                     'indus_7',
                     'indus_8',
                     'indus_9',
                     'indus_10',
                     'indus_11',
                     'indus_12',
                     'indus_13',
                     'indus_14',
                     'indus_15',
                     'indus_16',
                     'indus_17',
                     'indus_18',
                     'indus_19',
                     'indus_20',
                     'indus_21',
                     'indus_22',
                     'indus_23',
                     'indus_24',
                     'familymonthincome',
                     'selfmonthincome',
                     'wk_3y_exp_num',
                     'wk_exp1',
                     'wk_exp2',
                     'wk_exp3',
                     'wk_exp4',
                     'wk_exp5',
                     'wk_exp6',
                     'wk_exp7',
                     'wk_exp8',
                     'position1',
                     'position2',
                     'position3',
                     'position4',
                     'position5',
                     'position7',
                     'position8',
                     'position9',
                     'position10',
                     'position11',
                     'position12',
                     'position13',
                     'position14',
                     'position15',
                     'position16',
                     'position17',
                     'com_type1',
                     'com_type2',
                     'com_type3',
                     'com_type4',
                     'com_type5',
                     'com_type6',
                     'com_type7',
                     'com_type8',
                     'com_type9',
                     'native_provinve',
                     'native_city',
                     'family_province',
                     'family_city',
                     'native_city_n',
                     'family_city_n',
                     'native_city_1',
                     'native_city_2',
                     'native_city_3',
                     'native_city_4',
                     'native_city_5',
                     'native_city_6',
                     'native_city_7',
                     'native_city_8',
                     'native_city_9',
                     'native_city_10',
                     'native_city_11',
                     'native_city_12',
                     'native_city_13',
                     'native_city_14',
                     'native_city_15',
                     'native_city_16',
                     'native_city_17',
                     'native_city_18',
                     'native_city_19',
                     'native_city_20',
                     'native_city_21',
                     'native_city_22',
                     'native_city_23',
                     'native_city_24',
                     'native_city_25',
                     'native_city_26',
                     'native_city_27',
                     'native_city_28',
                     'native_city_29',
                     'native_city_30',
                     'native_city_31',
                     'native_city_32',
                     'native_city_33',
                     'native_city_34',
                     'native_city_35',
                     'native_city_36',
                     'native_city_37',
                     'native_city_38',
                     'native_city_39',
                     'native_city_40',
                     'native_city_41',
                     'native_city_42',
                     'native_city_43',
                     'native_city_44',
                     'native_city_45',
                     'native_city_46',
                     'native_city_47',
                     'native_city_48',
                     'native_city_49',
                     'native_city_50',
                     'native_city_51',
                     'native_city_52',
                     'native_city_53',
                     'native_city_54',
                     'native_city_55',
                     'native_city_56',
                     'native_city_57',
                     'native_city_58',
                     'native_city_59',
                     'native_city_60',
                     'native_city_61',
                     'native_city_62',
                     'native_city_63',
                     'native_city_64',
                     'native_city_65',
                     'native_city_66',
                     'native_city_67',
                     'native_city_68',
                     'native_city_69',
                     'native_city_70',
                     'native_city_71',
                     'native_city_72',
                     'native_city_73',
                     'native_city_74',
                     'native_city_75',
                     'native_city_76',
                     'native_city_77',
                     'native_city_78',
                     'native_city_79',
                     'native_city_80',
                     'native_city_81',
                     'native_city_82',
                     'native_city_83',
                     'native_city_84',
                     'native_city_85',
                     'native_city_86',
                     'native_city_87',
                     'native_city_88',
                     'native_city_89',
                     'native_city_90',
                     'native_city_91',
                     'native_city_92',
                     'native_city_93',
                     'native_city_94',
                     'native_city_95',
                     'native_city_96',
                     'native_city_97',
                     'native_city_98',
                     'native_city_99',
                     'native_city_100',
                     'native_city_101',
                     'native_city_102',
                     'native_city_103',
                     'native_city_104',
                     'native_city_105',
                     'native_city_106',
                     'native_city_107',
                     'native_city_108',
                     'native_city_109',
                     'native_city_110',
                     'native_city_111',
                     'native_city_112',
                     'native_city_113',
                     'native_city_114',
                     'native_city_115',
                     'native_city_116',
                     'native_city_117',
                     'native_city_118',
                     'native_city_119',
                     'native_city_120',
                     'native_city_121',
                     'native_city_122',
                     'native_city_123',
                     'native_city_124',
                     'native_city_125',
                     'native_city_126',
                     'native_city_127',
                     'native_city_128',
                     'native_city_129',
                     'native_city_130',
                     'native_city_131',
                     'native_city_132',
                     'native_city_133',
                     'native_city_134',
                     'native_city_135',
                     'native_city_136',
                     'native_city_137',
                     'native_city_138',
                     'native_city_139',
                     'native_city_140',
                     'native_city_141',
                     'native_city_142',
                     'native_city_143',
                     'native_city_144',
                     'native_city_145',
                     'native_city_146',
                     'native_city_147',
                     'native_city_148',
                     'native_city_149',
                     'native_city_150',
                     'native_city_151',
                     'native_city_152',
                     'native_city_153',
                     'native_city_154',
                     'native_city_155',
                     'native_city_156',
                     'native_city_157',
                     'native_city_158',
                     'native_city_159',
                     'native_city_160',
                     'native_city_161',
                     'native_city_162',
                     'native_city_163',
                     'native_city_164',
                     'native_city_165',
                     'native_city_166',
                     'native_city_167',
                     'native_city_168',
                     'native_city_169',
                     'native_city_170',
                     'native_city_171',
                     'native_city_172',
                     'native_city_173',
                     'native_city_174',
                     'native_city_175',
                     'native_city_176',
                     'native_city_177',
                     'native_city_178',
                     'native_city_179',
                     'native_city_180',
                     'native_city_181',
                     'native_city_182',
                     'native_city_183',
                     'native_city_184',
                     'native_city_185',
                     'native_city_186',
                     'native_city_187',
                     'native_city_188',
                     'native_city_189',
                     'native_city_190',
                     'native_city_191',
                     'native_city_192',
                     'native_city_193',
                     'native_city_194',
                     'native_city_195',
                     'native_city_196',
                     'native_city_197',
                     'native_city_198',
                     'native_city_199',
                     'native_city_200',
                     'native_city_201',
                     'native_city_202',
                     'native_city_203',
                     'native_city_204',
                     'native_city_205',
                     'native_city_206',
                     'native_city_207',
                     'native_city_208',
                     'native_city_209',
                     'native_city_210',
                     'native_city_211',
                     'native_city_212',
                     'native_city_213',
                     'native_city_214',
                     'native_city_215',
                     'native_city_216',
                     'native_city_217',
                     'native_city_218',
                     'native_city_219',
                     'native_city_220',
                     'native_city_221',
                     'native_city_222',
                     'native_city_223',
                     'native_city_224',
                     'native_city_225',
                     'native_city_226',
                     'native_city_227',
                     'native_city_228',
                     'native_city_229',
                     'native_city_230',
                     'native_city_231',
                     'native_city_232',
                     'native_city_233',
                     'native_city_234',
                     'native_city_235',
                     'native_city_236',
                     'native_city_237',
                     'native_city_238',
                     'native_city_239',
                     'native_city_240',
                     'native_city_241',
                     'native_city_242',
                     'native_city_243',
                     'native_city_244',
                     'native_city_245',
                     'native_city_246',
                     'native_city_247',
                     'native_city_248',
                     'native_city_249',
                     'native_city_250',
                     'native_city_251',
                     'native_city_252',
                     'native_city_253',
                     'native_city_254',
                     'native_city_255',
                     'native_city_256',
                     'native_city_257',
                     'native_city_258',
                     'native_city_259',
                     'native_city_260',
                     'native_city_261',
                     'native_city_262',
                     'native_city_263',
                     'native_city_264',
                     'native_city_265',
                     'native_city_266',
                     'native_city_267',
                     'native_city_268',
                     'native_city_269',
                     'native_city_270',
                     'native_city_271',
                     'native_city_272',
                     'native_city_273',
                     'native_city_274',
                     'native_city_275',
                     'native_city_276',
                     'native_city_277',
                     'native_city_278',
                     'native_city_279',
                     'native_city_280',
                     'native_city_281',
                     'native_city_282',
                     'native_city_283',
                     'native_city_284',
                     'native_city_285',
                     'native_city_286',
                     'native_city_287',
                     'native_city_288',
                     'native_city_289',
                     'native_city_290',
                     'native_city_291',
                     'native_city_292',
                     'native_city_293',
                     'native_city_294',
                     'native_city_295',
                     'native_city_296',
                     'native_city_297',
                     'native_city_298',
                     'native_city_299',
                     'native_city_300',
                     'native_city_301',
                     'native_city_302',
                     'native_city_303',
                     'native_city_304',
                     'native_city_305',
                     'native_city_306',
                     'native_city_307',
                     'native_city_308',
                     'native_city_309',
                     'native_city_310',
                     'native_city_311',
                     'native_city_312',
                     'native_city_313',
                     'native_city_314',
                     'native_city_315',
                     'native_city_316',
                     'family_city_1',
                     'family_city_2',
                     'family_city_3',
                     'family_city_4',
                     'family_city_5',
                     'family_city_6',
                     'family_city_7',
                     'family_city_8',
                     'family_city_9',
                     'family_city_10',
                     'family_city_11',
                     'family_city_12',
                     'family_city_13',
                     'family_city_14',
                     'family_city_15',
                     'family_city_16',
                     'family_city_17',
                     'family_city_18',
                     'family_city_19',
                     'family_city_20',
                     'family_city_21',
                     'family_city_22',
                     'family_city_23',
                     'family_city_24',
                     'family_city_25',
                     'family_city_26',
                     'family_city_27',
                     'family_city_28',
                     'family_city_29',
                     'family_city_30',
                     'family_city_31',
                     'family_city_32',
                     'family_city_33',
                     'family_city_34',
                     'family_city_35',
                     'family_city_36',
                     'family_city_37',
                     'family_city_38',
                     'family_city_39',
                     'family_city_40',
                     'family_city_41',
                     'family_city_42',
                     'family_city_43',
                     'family_city_44',
                     'family_city_45',
                     'family_city_46',
                     'family_city_47',
                     'family_city_48',
                     'family_city_49',
                     'family_city_50',
                     'family_city_51',
                     'family_city_52',
                     'family_city_53',
                     'family_city_54',
                     'family_city_55',
                     'family_city_56',
                     'family_city_57',
                     'family_city_58',
                     'family_city_59',
                     'family_city_60',
                     'family_city_61',
                     'family_city_62',
                     'family_city_63',
                     'family_city_64',
                     'family_city_65',
                     'family_city_66',
                     'family_city_67',
                     'family_city_68',
                     'family_city_69',
                     'family_city_70',
                     'family_city_71',
                     'family_city_72',
                     'family_city_73',
                     'family_city_74',
                     'family_city_75',
                     'family_city_76',
                     'family_city_77',
                     'family_city_78',
                     'family_city_79',
                     'family_city_80',
                     'family_city_81',
                     'family_city_82',
                     'family_city_83',
                     'family_city_84',
                     'family_city_85',
                     'family_city_86',
                     'family_city_87',
                     'family_city_88',
                     'family_city_89',
                     'family_city_90',
                     'family_city_91',
                     'family_city_92',
                     'family_city_93',
                     'family_city_94',
                     'family_city_95',
                     'family_city_96',
                     'family_city_97',
                     'family_city_98',
                     'family_city_99',
                     'family_city_100',
                     'family_city_101',
                     'family_city_102',
                     'family_city_103',
                     'family_city_104',
                     'family_city_105',
                     'family_city_106',
                     'family_city_107',
                     'family_city_108',
                     'family_city_109',
                     'family_city_110',
                     'family_city_111',
                     'family_city_112',
                     'family_city_113',
                     'family_city_114',
                     'family_city_115',
                     'family_city_116',
                     'family_city_117',
                     'family_city_118',
                     'family_city_119',
                     'family_city_120',
                     'family_city_121',
                     'family_city_122',
                     'family_city_123',
                     'family_city_124',
                     'family_city_125',
                     'family_city_126',
                     'family_city_127',
                     'family_city_128',
                     'family_city_129',
                     'family_city_130',
                     'family_city_131',
                     'family_city_132',
                     'family_city_133',
                     'family_city_134',
                     'family_city_135',
                     'family_city_136',
                     'family_city_137',
                     'family_city_138',
                     'family_city_139',
                     'family_city_140',
                     'family_city_141',
                     'family_city_142',
                     'family_city_143',
                     'family_city_144',
                     'family_city_145',
                     'family_city_146',
                     'family_city_147',
                     'family_city_148',
                     'family_city_149',
                     'family_city_150',
                     'family_city_151',
                     'family_city_152',
                     'family_city_153',
                     'family_city_154',
                     'family_city_155',
                     'family_city_156',
                     'family_city_157',
                     'family_city_158',
                     'family_city_159',
                     'family_city_160',
                     'family_city_161',
                     'family_city_162',
                     'family_city_163',
                     'family_city_164',
                     'family_city_165',
                     'family_city_166',
                     'family_city_167',
                     'family_city_168',
                     'family_city_169',
                     'family_city_170',
                     'family_city_171',
                     'family_city_172',
                     'family_city_173',
                     'family_city_174',
                     'family_city_175',
                     'family_city_176',
                     'family_city_177',
                     'family_city_178',
                     'family_city_179',
                     'family_city_180',
                     'family_city_181',
                     'family_city_182',
                     'family_city_183',
                     'family_city_184',
                     'family_city_185',
                     'family_city_186',
                     'family_city_187',
                     'family_city_188',
                     'family_city_189',
                     'family_city_190',
                     'family_city_191',
                     'family_city_192',
                     'family_city_193',
                     'family_city_194',
                     'family_city_195',
                     'family_city_196',
                     'family_city_197',
                     'family_city_198',
                     'family_city_199',
                     'family_city_200',
                     'family_city_201',
                     'family_city_202',
                     'family_city_203',
                     'family_city_204',
                     'family_city_205',
                     'family_city_206',
                     'family_city_207',
                     'family_city_208',
                     'family_city_209',
                     'family_city_210',
                     'family_city_211',
                     'family_city_212',
                     'family_city_213',
                     'family_city_214',
                     'family_city_215',
                     'family_city_216',
                     'family_city_217',
                     'family_city_218',
                     'family_city_219',
                     'family_city_220',
                     'family_city_221',
                     'family_city_222',
                     'family_city_223',
                     'family_city_224',
                     'family_city_225',
                     'family_city_226',
                     'family_city_227',
                     'family_city_228',
                     'family_city_229',
                     'family_city_230',
                     'family_city_231',
                     'family_city_232',
                     'family_city_233',
                     'family_city_234',
                     'family_city_235',
                     'family_city_236',
                     'family_city_237',
                     'family_city_238',
                     'family_city_239',
                     'family_city_240',
                     'family_city_241',
                     'family_city_242',
                     'family_city_243',
                     'family_city_244',
                     'family_city_245',
                     'family_city_246',
                     'family_city_247',
                     'family_city_248',
                     'family_city_249',
                     'family_city_250',
                     'family_city_251',
                     'family_city_252',
                     'family_city_253',
                     'family_city_254',
                     'family_city_255',
                     'family_city_256',
                     'family_city_257',
                     'family_city_258',
                     'family_city_259',
                     'family_city_260',
                     'family_city_261',
                     'family_city_262',
                     'family_city_263',
                     'family_city_264',
                     'family_city_265',
                     'family_city_266',
                     'family_city_267',
                     'family_city_268',
                     'family_city_269',
                     'family_city_270',
                     'family_city_271',
                     'family_city_272',
                     'family_city_273',
                     'family_city_274',
                     'family_city_275',
                     'family_city_276',
                     'family_city_277',
                     'family_city_278',
                     'family_city_279',
                     'family_city_280',
                     'family_city_281',
                     'family_city_282',
                     'family_city_283',
                     'family_city_284',
                     'family_city_285',
                     'family_city_286',
                     'family_city_287',
                     'family_city_288',
                     'family_city_289',
                     'family_city_290',
                     'family_city_291',
                     'family_city_292',
                     'family_city_293',
                     'family_city_294',
                     'family_city_295',
                     'family_city_296',
                     'family_city_297',
                     'family_city_298',
                     'family_city_299',
                     'family_city_300',
                     'family_city_301',
                     'family_city_302',
                     'family_city_303',
                     'family_city_304',
                     'family_city_305',
                     'family_city_306',
                     'family_city_307',
                     'family_city_308',
                     'family_city_309',
                     'family_city_310'
                     ]]

kmeans = KMeans(n_clusters=8, random_state=9)
model = kmeans.fit(X_train)

label_pred = model.labels_ #获取聚类标签
centroids = model.cluster_centers_ #获取聚类中心
inertia = model.inertia_ # 获取聚类准则的总

# df = pd.DataFrame(dataSet,index=labels,columns=['x','y'])

for i in range(5,30,1):
    clf = KMeans(n_clusters=i)
    s = clf.fit(X_train)
    print (i , clf.inertia_)

df_labels = pd.DataFrame(label_pred,columns=['clus_res'])

df = pd.concat([trainData, df_labels], axis = 1)

df.head()




